rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // Helper function to check if user is super admin (mainadmin role)
    // Checks the role field in the admins collection
    function isMainAdmin() {
      return request.auth != null && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'mainadmin';
    }
    
    // Events collection - read only for public
    match /events/{eventId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // Team members collection - read only for public
    match /team/{memberId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // Gallery images collection (legacy) - read only for public
    match /gallery/{imageId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // Galleries collection - read only for public
    match /galleries/{galleryId} {
      allow read: if true;
      allow write: if request.auth != null;
      
      // Images subcollection within galleries
      match /images/{imageId} {
        allow read: if true;
        allow write: if request.auth != null;
      }
    }
    
    // Contact submissions - anyone can create, only admins can read
    match /contacts/{contactId} {
      allow create: if true;
      allow read: if request.auth != null;
    }
    
    // Notifications collection - read for public, write for admins
    match /notifications/{notificationId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // Settings collection - read for public, write for admins
    match /settings/{settingId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // Admins collection - admins can read all (for role checking), main admin can manage admins
    match /admins/{adminId} {
      // Any admin can read admin documents (needed for role checking in User Management)
      // Check if user exists in admins collection - this allows reading any admin document
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      // Allow list/query operations for all admins (needed for role checking and Admin Permissions page)
      // Check if user exists in admins collection
      allow list: if request.auth != null && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      // Super admin can create admin documents (when promoting users to admin)
      allow create: if request.auth != null && isMainAdmin();
      // Super admin can update admin documents (for permissions management)
      allow update: if request.auth != null && isMainAdmin();
      // Super admin can delete admin documents (when demoting admins to users)
      // Note: Application code should prevent deleting super admin documents
      allow delete: if request.auth != null && isMainAdmin();
    }
    
    // FCM Tokens collection - allow anyone to create/update their own token
    match /fcmTokens/{deviceId} {
      allow create: if true; // Allow creating tokens
      allow update: if true; // Allow updating tokens
      allow read: if request.auth != null; // Only admins can read (for sending notifications)
    }
    
    // Users collection - members can read/update their own profile, admins can read all
    // Also allow reading profiles that are opted into the directory
    match /users/{userId} {
      // Allow reading if:
      // 1. User is reading their own profile (authenticated)
      // 2. User is an admin (authenticated)
      // 3. Profile has showInDirectory == true (for public member directory - no auth required)
      // Note: For queries to work, we need to allow reading profiles with showInDirectory == true
      // even for unauthenticated users, since the member directory should be publicly accessible
      allow read: if (
        (request.auth != null && request.auth.uid == userId) || 
        (request.auth != null && isAdmin()) ||
        resource.data.showInDirectory == true
      );
      // Allow list operations for both authenticated and unauthenticated users
      // This is needed for queries with where clauses (member directory is public)
      // The read rule above will filter which documents can actually be read
      allow list: if true;
      // Users can create their own profile
      allow create: if request.auth != null && request.auth.uid == userId;
      // Users can update their own profile, admins can update any user
      allow update: if request.auth != null && (request.auth.uid == userId || isAdmin());
      // Only admins can delete users
      allow delete: if request.auth != null && isAdmin();
    }
    
    // Activity logs collection - users can create and read their own, admins can read all
    match /activityLogs/{logId} {
      // Authenticated users can create logs
      allow create: if request.auth != null;
      // Users can read their own logs, admins can read/list all logs
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      // Only admins can delete logs
      allow delete: if request.auth != null && isAdmin();
    }

    // Event forms collection - admins can read/write, public can read
    match /eventForms/{formId} {
      allow read: if true; // Public can read form configurations
      allow write: if request.auth != null && isAdmin();
    }

    // Form templates collection - admins can read/write
    match /formTemplates/{templateId} {
      allow read: if request.auth != null && isAdmin();
      allow write: if request.auth != null && isAdmin();
    }

    // Event registrations collection
    match /eventRegistrations/{registrationId} {
      // Users can create their own registrations
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
      // Users can read their own registrations, admins can read all
      // Also allow reading registrations for capacity checks (all authenticated users)
      // Note: This allows reading eventId and status for capacity calculations
      // Application should only use count, not personal data
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        isAdmin() ||
        // Allow reading for capacity checks - users need to count registrations
        // This is a necessary trade-off for capacity management
        resource.data.eventId != null
      );
      // Allow list/query operations for authenticated users
      // Needed for capacity checks and checking existing registrations
      allow list: if request.auth != null;
      // Users can update their own registrations (e.g., cancel), admins can update any
      allow update: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      // Only admins can delete registrations
      allow delete: if request.auth != null && isAdmin();
    }

    // Profile change requests collection
    match /profileChangeRequests/{requestId} {
      // Users can create their own change requests
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
      // Users can read their own requests, admins can read all
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      // Allow list/query operations for authenticated users
      // Needed for users to check their pending requests
      allow list: if request.auth != null;
      // Only admins can update requests (approve/reject)
      allow update: if request.auth != null && isAdmin();
      // Only admins can delete requests
      allow delete: if request.auth != null && isAdmin();
    }

    // Forum posts collection
    match /forumPosts/{postId} {
      // Anyone can read posts (public forum)
      allow read: if true;
      // Allow list/query operations for everyone
      allow list: if true;
      // Authenticated users can create posts
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.authorId;
      // Users can update their own posts, admins can update any
      // Authenticated users can also update posts for voting (upvotes/downvotes fields)
      // We allow updates if user is authenticated and authorId hasn't changed
      // This enables voting while preventing unauthorized content edits
      allow update: if request.auth != null && (
        resource.data.authorId == request.auth.uid ||
        isAdmin() ||
        // Allow any authenticated user to update if authorId remains the same
        // This allows voting (upvotes/downvotes) while protecting against content changes
        // Application code ensures only vote fields are updated by non-authors
        request.resource.data.authorId == resource.data.authorId
      );
      // Users can delete their own posts, admins can delete any
      allow delete: if request.auth != null && (
        resource.data.authorId == request.auth.uid ||
        isAdmin()
      );
    }

    // Forum replies collection
    match /forumReplies/{replyId} {
      // Anyone can read replies (public forum)
      allow read: if true;
      // Allow list/query operations for everyone
      allow list: if true;
      // Authenticated users can create replies
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.authorId;
      // Users can update their own replies, admins can update any
      allow update: if request.auth != null && (
        resource.data.authorId == request.auth.uid ||
        isAdmin()
      );
      // Users can delete their own replies, admins can delete any
      allow delete: if request.auth != null && (
        resource.data.authorId == request.auth.uid ||
        isAdmin()
      );
    }

    // Feedback collection
    match /feedback/{feedbackId} {
      // Anyone can create feedback
      allow create: if true;
      // Only admins can read feedback
      allow read: if request.auth != null && isAdmin();
      // Allow list/query operations for admins
      allow list: if request.auth != null && isAdmin();
      // Only admins can update feedback
      allow update: if request.auth != null && isAdmin();
      // Only admins can delete feedback
      allow delete: if request.auth != null && isAdmin();
    }

    // Banned users collection - admins can read/write, public can read for checking during signup
    match /bannedUsers/{banId} {
      // Anyone can read to check if email/roll number is banned (needed for signup)
      allow read: if true;
      // Allow list/query operations for everyone (needed for checking during signup)
      allow list: if true;
      // Only admins can create/update/delete ban entries
      allow create: if request.auth != null && isAdmin();
      allow update: if request.auth != null && isAdmin();
      allow delete: if request.auth != null && isAdmin();
    }
  }
}
